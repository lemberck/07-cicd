name: CD - Pull and Deploy

# This workflow is triggered after the CI workflow has successfully completed
on:
  workflow_run:
    workflows: ["CI - Lint, Build, and Push Docker Images"]
    types:
      - completed
    branches: [ main ]
  workflow_dispatch:  # Adds a manual trigger for the workflow

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Ensure the job only runs if the triggering CI workflow was successful
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Check out repository code
        uses: actions/checkout@v2
      
      # Install Minikube dependencies, including conntrack and crictl
      - name: Install Minikube dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y conntrack
          VERSION="v1.21.0" # use the latest version compatible with your Kubernetes
          curl -L https://github.com/kubernetes-sigs/cri-tools/releases/download/v${VERSION}/crictl-v${VERSION}-linux-amd64.tar.gz | sudo tar -C /usr/local/bin -xz
      
      # Start Minikube
      - name: Start Minikube
        run: |
          curl -Lo minikube https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
          sudo install minikube /usr/local/bin/
          sudo minikube start --driver=none
          minikube update-context

      # Install kubectl
      - name: Install kubectl
        run: |
          curl -LO "https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x ./kubectl
          sudo mv ./kubectl /usr/local/bin/kubectl
          kubectl version --client

      # Install Helm
      - name: Install Helm
        run: |
          curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3
          chmod 700 get_helm.sh
          ./get_helm.sh

      # Deploy the application using Helm
      - name: Deploy with Helm
        run: |
          helm upgrade --install sentiment-analysis ./helm-sentiment-analysis-mlops --namespace sentiment-analysis-mlops --create-namespace

      # Optionally, verify the deployment
      - name: Verify deployment
        run: |
          kubectl rollout status deployment/sentiment-analysis-backend --namespace sentiment-analysis-mlops
          kubectl rollout status deployment/sentiment-analysis-frontend --namespace sentiment-analysis-mlops

      # Cleanup steps can be included as well or set up as separate manual jobs
